{"version":3,"names":["_mapMessageToStorable","require","_mapReactionToStorable","_mapUserToStorable","_QuickSqliteClient","_createDeleteQuery","_createSelectQuery","_createUpdateQuery","_createUpsertQuery","updateMessage","_ref","_ref$flush","flush","message","queries","messages","QuickSqliteClient","executeSql","apply","createSelectQuery","id","length","push","createUpdateQuery","mapMessageToStorable","user","createUpsertQuery","mapUserToStorable","createDeleteQuery","messageId","latestReactions","latest_reactions","ownReactions","own_reactions","concat","_toConsumableArray2","forEach","r","mapReactionToStorable","executeSqlBatch","exports"],"sources":["updateMessage.ts"],"sourcesContent":["import type { FormatMessageResponse, MessageResponse } from 'stream-chat';\n\nimport { mapMessageToStorable } from '../mappers/mapMessageToStorable';\nimport { mapReactionToStorable } from '../mappers/mapReactionToStorable';\nimport { mapUserToStorable } from '../mappers/mapUserToStorable';\nimport { QuickSqliteClient } from '../QuickSqliteClient';\nimport { createDeleteQuery } from '../sqlite-utils/createDeleteQuery';\nimport { createSelectQuery } from '../sqlite-utils/createSelectQuery';\nimport { createUpdateQuery } from '../sqlite-utils/createUpdateQuery';\nimport { createUpsertQuery } from '../sqlite-utils/createUpsertQuery';\nimport type { PreparedQueries } from '../types';\n\nexport const updateMessage = ({\n  flush = true,\n  message,\n}: {\n  message: MessageResponse | FormatMessageResponse;\n  flush?: boolean;\n}) => {\n  const queries: PreparedQueries[] = [];\n\n  const messages = QuickSqliteClient.executeSql.apply(\n    null,\n    createSelectQuery('messages', ['*'], {\n      id: message.id,\n    }),\n  );\n\n  if (messages.length === 0) {\n    return queries;\n  }\n\n  queries.push(\n    createUpdateQuery('messages', mapMessageToStorable(message), {\n      id: message.id,\n    }),\n  );\n\n  if (message.user) {\n    queries.push(createUpsertQuery('users', mapUserToStorable(message.user)));\n  }\n\n  queries.push(\n    createDeleteQuery('reactions', {\n      messageId: message.id,\n    }),\n  );\n\n  const latestReactions = message.latest_reactions || [];\n  const ownReactions = message.own_reactions || [];\n\n  [...latestReactions, ...ownReactions].forEach((r) => {\n    if (r.user) {\n      queries.push(createUpsertQuery('users', mapUserToStorable(r.user)));\n    }\n\n    queries.push(createUpsertQuery('reactions', mapReactionToStorable(r)));\n  });\n\n  if (flush) {\n    QuickSqliteClient.executeSqlBatch(queries);\n  }\n\n  return queries;\n};\n"],"mappings":";;;;;;AAEA,IAAAA,qBAAA,GAAAC,OAAA;AACA,IAAAC,sBAAA,GAAAD,OAAA;AACA,IAAAE,kBAAA,GAAAF,OAAA;AACA,IAAAG,kBAAA,GAAAH,OAAA;AACA,IAAAI,kBAAA,GAAAJ,OAAA;AACA,IAAAK,kBAAA,GAAAL,OAAA;AACA,IAAAM,kBAAA,GAAAN,OAAA;AACA,IAAAO,kBAAA,GAAAP,OAAA;AAGO,IAAMQ,aAAa,GAAG,SAAhBA,aAAaA,CAAAC,IAAA,EAMpB;EAAA,IAAAC,UAAA,GAAAD,IAAA,CALJE,KAAK;IAALA,KAAK,GAAAD,UAAA,cAAG,IAAI,GAAAA,UAAA;IACZE,OAAO,GAAAH,IAAA,CAAPG,OAAO;EAKP,IAAMC,OAA0B,GAAG,EAAE;EAErC,IAAMC,QAAQ,GAAGC,oCAAiB,CAACC,UAAU,CAACC,KAAK,CACjD,IAAI,EACJ,IAAAC,oCAAiB,EAAC,UAAU,EAAE,CAAC,GAAG,CAAC,EAAE;IACnCC,EAAE,EAAEP,OAAO,CAACO;EACd,CAAC,CACH,CAAC;EAED,IAAIL,QAAQ,CAACM,MAAM,KAAK,CAAC,EAAE;IACzB,OAAOP,OAAO;EAChB;EAEAA,OAAO,CAACQ,IAAI,CACV,IAAAC,oCAAiB,EAAC,UAAU,EAAE,IAAAC,0CAAoB,EAACX,OAAO,CAAC,EAAE;IAC3DO,EAAE,EAAEP,OAAO,CAACO;EACd,CAAC,CACH,CAAC;EAED,IAAIP,OAAO,CAACY,IAAI,EAAE;IAChBX,OAAO,CAACQ,IAAI,CAAC,IAAAI,oCAAiB,EAAC,OAAO,EAAE,IAAAC,oCAAiB,EAACd,OAAO,CAACY,IAAI,CAAC,CAAC,CAAC;EAC3E;EAEAX,OAAO,CAACQ,IAAI,CACV,IAAAM,oCAAiB,EAAC,WAAW,EAAE;IAC7BC,SAAS,EAAEhB,OAAO,CAACO;EACrB,CAAC,CACH,CAAC;EAED,IAAMU,eAAe,GAAGjB,OAAO,CAACkB,gBAAgB,IAAI,EAAE;EACtD,IAAMC,YAAY,GAAGnB,OAAO,CAACoB,aAAa,IAAI,EAAE;EAEhD,GAAAC,MAAA,KAAAC,mBAAA,aAAIL,eAAe,OAAAK,mBAAA,aAAKH,YAAY,GAAEI,OAAO,CAAC,UAACC,CAAC,EAAK;IACnD,IAAIA,CAAC,CAACZ,IAAI,EAAE;MACVX,OAAO,CAACQ,IAAI,CAAC,IAAAI,oCAAiB,EAAC,OAAO,EAAE,IAAAC,oCAAiB,EAACU,CAAC,CAACZ,IAAI,CAAC,CAAC,CAAC;IACrE;IAEAX,OAAO,CAACQ,IAAI,CAAC,IAAAI,oCAAiB,EAAC,WAAW,EAAE,IAAAY,4CAAqB,EAACD,CAAC,CAAC,CAAC,CAAC;EACxE,CAAC,CAAC;EAEF,IAAIzB,KAAK,EAAE;IACTI,oCAAiB,CAACuB,eAAe,CAACzB,OAAO,CAAC;EAC5C;EAEA,OAAOA,OAAO;AAChB,CAAC;AAAC0B,OAAA,CAAA/B,aAAA,GAAAA,aAAA"}