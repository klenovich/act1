var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.upsertMessages = void 0;
var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));
var _mapMessageToStorable = require("../mappers/mapMessageToStorable");
var _mapReactionToStorable = require("../mappers/mapReactionToStorable");
var _mapUserToStorable = require("../mappers/mapUserToStorable");
var _QuickSqliteClient = require("../QuickSqliteClient");
var _createUpsertQuery = require("../sqlite-utils/createUpsertQuery");
var upsertMessages = function upsertMessages(_ref) {
  var _ref$flush = _ref.flush,
    flush = _ref$flush === void 0 ? true : _ref$flush,
    messages = _ref.messages;
  var usersToUpsert = [];
  var messagesToUpsert = [];
  var reactionsToUpsert = [];
  messages == null ? void 0 : messages.forEach(function (message) {
    messagesToUpsert.push((0, _createUpsertQuery.createUpsertQuery)('messages', (0, _mapMessageToStorable.mapMessageToStorable)(message)));
    if (message.user) {
      usersToUpsert.push((0, _createUpsertQuery.createUpsertQuery)('users', (0, _mapUserToStorable.mapUserToStorable)(message.user)));
    }
    [].concat((0, _toConsumableArray2["default"])(message.latest_reactions || []), (0, _toConsumableArray2["default"])(message.own_reactions || [])).forEach(function (r) {
      if (r.user) {
        usersToUpsert.push((0, _createUpsertQuery.createUpsertQuery)('users', (0, _mapUserToStorable.mapUserToStorable)(r.user)));
      }
      reactionsToUpsert.push((0, _createUpsertQuery.createUpsertQuery)('reactions', (0, _mapReactionToStorable.mapReactionToStorable)(r)));
    });
  });
  var finalQueries = [].concat(messagesToUpsert, reactionsToUpsert, usersToUpsert);
  if (flush) {
    _QuickSqliteClient.QuickSqliteClient.executeSqlBatch(finalQueries);
  }
  return finalQueries;
};
exports.upsertMessages = upsertMessages;
//# sourceMappingURL=upsertMessages.js.map